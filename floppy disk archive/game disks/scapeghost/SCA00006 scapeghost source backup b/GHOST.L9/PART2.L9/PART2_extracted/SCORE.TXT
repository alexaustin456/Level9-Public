; Standard adventure sources 14/5/88
;
; score code
;
; 14/5/88

 begin

.CalcScore
; return X4=current score
 x1=32 ; start of score table
 x4=0

.CalcScore1
 x2=list7(x1)
 if x2<128 then calcScoreNotNegative
; convert negative 8 bit number to negative 16 bit
 x3=65280
 add x2,x3

.calcScoreNotNegative
 add x4,x2
 add x1,c1
 if x1<ScMaxPlus1 then CalcScore1

 add x4,GeneralScoreAddition

;=====
; score for evidence in hall
 x9=x4
 gosub countevidence
 x4=x9 ; done this way because x4 is corrupted!
;=====

 cif NotPart1
 add x4,lastpartscore
 cend

 return
;---
;=====
; destroy all evidence in hall (but not hidden in phone directory)
.dodestroyevidence
 destroyevidence=true
;---
; count all evidence in hall (but not hidden in phone directory) and 
; return the value in x8.
; on exit for score purposes, 5*x8 is added to x9
.countevidence
 pos=14
 hipos=0
 object=mintreasure
 x8=0
.ce1
 x1=hicurrentpos(object)		; special case to exempt
 if x1<>in then cenotindirectory	; evidence hidden in 
 x1=currentpos(object)			; telephone directory
 if x1=directory then nextce
.cenotindirectory
 gosub @checkobjectpos
 if result=false then nextce
 add x8,c1				; add to total
 x2=5
 add x9,x2				; add score value
 if destroyevidence=false then nextce
 currentpos(object)=c0			; used if firemen remove evidence
.nextce
 add object,c1
 if object<maxtreasureplus1 then ce1
 destroyevidence=false
 return
;=====
;---
.SCORE
 MESSAGE 2240 ; you score
 
;;.PRINTSCORE ; >> Pete 14/9/89 
 gosub @CalcScore
 x1=x4 ;*
 IF X4<30000 THEN SCORE1 ; failsafe test to prevent negative score
 message 2243 ; minus sign
; x1=x4 ;*
 x4=0
 sub x4,x1

.SCORE1
 PRINT X4 ; score

 cif NotPart1
 sub x4,lastpartscore
 cend

 M1=2249 ; message below lowest rating
 MESSAGE 2242 ; out of 300 and are
 if x1>30000 then @forceM1Dot ;* rating for -ve score is 2249
 X1=30 ; size of score categories (max score, 300, has unique rating)
.SCORE2
 SUB x4,X1
 ADD M1,C1
 IF x4<NEGATIVE THEN SCORE2
 goto @forceM1dot
;---
;=====
; add 20 to generalscoreaddition for evidence found, 
; and if joe is present, he gives a total of the evidence discovered
.addevidencescore
 add evidencefound,c1			; add to evidence "tally"
 x1=20
 add generalscoreaddition,x1		; add 20 to evidence score
;
; apologies for the crude method of detecting joe's presence.
; this is because I cannot risk corrupting OBJECT by using CHECKIFPRESENT
 x3=hicurrentpos(joe)
 if x3<>0 then aesret			; user discovered evidence,
 x3=currentpos(joe)
 if x3<>room then aesret		; but joe is not here
 m1=blankline
 gosub @printm1
 m1=2759
 add m1,evidencefound			; joe gives total of evidence 
 goto @printm1dot			; discovered
;=====

.AddScore10
 x2=10
 goto AddScorex2

.AddScore20
 x2=20
 goto AddScoreX2

.AddScore25
 x2=25
 goto AddScoreX2

;;.ClearScore ; >> Pete 14/9/89 
;; x2=0 ; >> Pete 14/9/89 

.AddScoreX2
 x3=32
 add x1,x3 ; add offset to start of score table
 list7(x1)=x2
.aesret
 return
;---
