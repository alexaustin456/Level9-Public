; Lenslok code
;
; 27/05/86
;
 VAR
 GAMEOVER ;>>
 I1 I2 R1
 PARSEX1 PARSEX2 PARSEX3 PARSEX4 PARSEX5 PARSEX6
 LASTOOPSROOM
 OOPSPOSEND
 OOPSPOS
 NEXTOOPSPOS
 NEXTOOPSEND

 BEGIN
;-----

.SOLVEDPREVIOUS
;For use in SCORE message.
 IF C0<>FIRSTPART THEN SOLVED1 ;No previous game ?

 IF GAMESOLVED<>SOLVING THEN SOLVED1 ;>>
;>> IF VERSION<>GAMECOMPLETE THEN SOLVED1
 MESSAGE 4315 ;You have solved the previous game(s)  >> ANDY 14 8 86
.SOLVED1
 RETURN
;
;-----

.ASKFINAL
;Called when current game is complete

;Second and final parts are continuation of previous parts
;if 'complete' flag already set.
 IF C0<>FIRSTPART THEN ASK2A
;>> IF VERSION<>GAMECOMPLETE THEN QUITPLAYAGAIN
 IF GAMESOLVED<>SOLVING THEN @QUITPLAYAGAIN ;>>
.ASK2
;If the final part and solved previous parts then win entire trilogy
 IF C0<>FINALPART THEN SOLVEDALL

.ASK2A ;>>
 MESSAGE 4313 ;Do you want to SAVE final position ?  >> ANDY 14 8 86
 GOSUB ASKINPUT
 IF RESULT=FALSE THEN ASK2A ;>>
;>> IF RESULT=FALSE THEN ASK2
 I1=VERB ; >>MIKE 18/8/86
 IF I1=IYES THEN SAVEFINAL
 IF I1=INO THEN @QUITPLAYAGAIN
;>>MIKE 18/8/86 IF I1=INORTH THEN QUITPLAYAGAIN
 GOTO ASK2A ;>>
;>> GOTO ASKFINAL
.SAVEFINAL
 GAMESOLVED=ENDPOSITION ;>>
;(Don't return to game play after here)
;>>VERSION=GAMECOMPLETE
 SAVE
 GOTO ASK2A ;>>
;>> GOTO ASKFINAL
.SOLVEDALL
 MESSAGE 4316 ;You have solved the entire trilogy    >> ANDY 14 8 86
 GOTO @QUITPLAYAGAIN

;-----

;.ASKINPUT
; NOMOREINPUT=FALSE         ;> NICK 12/8/86
; GOSUB @GETNEXTWORD        ;> NICK 12/8/86
; IF EOL=TRUE THEN ASKINPUT ;> NICK 12/8/86
; SEARCHTYPE=NOUNTYPE       ;> NICK 12/8/86
; GOSUB @CHECKTYPE          ;> NICK 12/8/86
;;> NICK 12/8/86 GOSUB @CLEARINPUT
;;> NICK 12/8/86 GOSUB @GETI1I2I3I4
; IF I1=IRAM THEN ASKIN2
; IF I1=IOOPS THEN ASKIN3
; IF I1=IRESTORE THEN ASKIN1
; RESULT=TRUE
; RETURN
.ASKINPUT
 GOSUB @getnextword ;PARSEINPUT
 searchtype=verbtype
 gosub @checktype
 IF Value=IRAM THEN ASKIN2
 IF Value=IOOPS THEN ASKIN3
;>>** IF VERB=IRESTORE THEN ASKIN2
 RESULT=TRUE
 RETURN

;.ASKIN1
; GOSUB @LENSLOK
; IF RESULT=FALSE THEN ASKIN4
; RESTORE
; IF GAMEOVER=TRUE THEN @STARTGAME ;>>For disk save/restore on null filename
; GOTO @AFTERRESTORE

.ASKIN2
 gosub @clearinput ;>>mike 19/10/86
 NOMOREINPUT=TRUE
 GOSUB @RAMLOAD
 goto afterrestore

.ASKIN3
 gosub @clearinput ;>>mike 19/10/86
 GOSUB @TRYOOPS
 goto @afterrestore ;>>mike 19/10/86 - was IF RESULT=TRUE THEN @AFTERRESTORE ;>> ENDCOMMAND

.ASKIN4
 RESULT=FALSE
 RETURN

;-----

.CQUITPLAYAGAIN ;** WAS QUITPLAYAGAIN. SEE QUITPLAYAGAIN IN AVERB.TXT
                ;** 12-8-86  ANDY
 gosub @clearinput
 supresschecking=true
 GAMEOVER=TRUE ;>>
 if nomoreinput=false then cqpa1
 MESSAGE 4311 ;Quit or Restore ?                     >> ANDY 14 8 86
 nomoreinput=false ;>>mike 19/10/86

.cqpa1
 GOSUB ASKINPUT
 IF value=IQUIT THEN @STARTGAME
 if value=irestore then @restore
 GOTO @CQUITPLAYAGAIN

;-----

.ABORTGAME
 MESSAGE 4310 ;Press space                           >> ANDY 14 8 86

.WAITFORSPACE ;Variables may be corrupted
 C0=0
 C1=1
 C3=3
 LINPUT(C0)=C3
 DRIVER
 X1=LINPUT(C1)
 IF X1<>32 THEN WAITFORSPACE
 GOTO @STARTGAME

;-----

.CWORDS  ;** WAS WORDS. SEE WORDS IN AVERB.TXT
         ;** 12-8-86 ANDY

 SCREEN T
 RETURN ;>>MIKE 12/8/86 GOTO @ENDCOMMAND

;-----

.PICTURES
 SCREEN G C0
 LASTPICTURE=0
 GOTO @DESCRIBEROOM ;>>MIKE 12/8/6 Re-describe room

;-----

.AFTERRESTORE
;After a RESTORE or RAMLOAD or PICTURES
 C0=0 ;>>
 LASTPICTURE=0 ;>>
;Solved current part of previous game?
 IF GAMESOLVED<>ENDPOSITION THEN AFTER2 ;>>
 IF VERSION=GAMECODE THEN @DIE ;>>Solved current game
 IF C0<>FIRSTPART THEN AFTER2 ;First part can't be a chain
 IF VERSION<>PREVIOUSGAMECODE THEN AFTER2 ;>>
;Solved previous game.
;Mark as having solved all previous parts:
 MESSAGE 4317 ;>>                                    >> ANDY 14 8 86
 CLEAR ;>>Assign zero to first 128 variables
 VERSION=GAMECODE ;>>
 GAMESOLVED=SOLVING ;>>
 GOTO @RETURNTOSTART

.AFTER2
 IF VERSION<>GAMECODE THEN WRONGPOSITION ;Wong game restored
 IF C1<>1 THEN WRONGPOSITION
 IF C2<>2 THEN WRONGPOSITION
 IF C3=3 THEN afterrestoreok
.WRONGPOSITION
 MESSAGE 4314 ;Bad restored position                 >> ANDY 14 8 86
 GOTO @ABORTGAME

.afterrestoreok
 gosub @describeroom
 nomoreinput=true
 goto @cancelinput
;-----

;-------------------------------------------------------------------
;--------------------------------------------------------
